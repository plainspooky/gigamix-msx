;===== DM-system2 [PSGPLAY] =====
;(C)1995 GIGAMIX/KICHI/Influenza

USRDAT	EQU	0F7F8H
VDP	EQU	0006H
PSG	EQU	00093H
WKHIGH	EQU	2DH	;2C00H+256

	ORG	XPCMDR
;---------------------------
;		 0....5....10...15...20...25...30...35...
	DEFM	'EI-PSGPLAY  1995 KICHI/GIGAMIX/Influenza'
	DEFB	1AH,01H
	DEFS	6
;--------------------------
	PUSH	HL
	PUSH	DE
	PUSH	BC
	LD	HL,MRAM
	LD	DE,LOOP1
	LD	BC,4
	ADD	A,A
	JR	NC,$+3
	ADD	HL,BC
	RRCA
	LDIR
	LD	L,A
	OR	A
	LD	A,1		; 15.75
	JR	Z,TIWT
	DEC	L
	LD	A,15-1		; 7.875
	JR	Z,TIWT
	DEC	L
	LD	A,29-1		; 5.25
	JR	Z,TIWT
	DEC	L
	LD	A,44-1		; 3.9375
	JR	Z,TIWT
	DEC	L
	LD	A,L
TIWT:	LD	(TIME+1),A

	LD	L,0
	CALL	PSGCHN

	CALL	4025H	;GETCPU
	PUSH	AF
	XOR	A
	CALL	4022H	;CHGCPU
	POP	AF
	POP	BC
	POP	DE
	POP	HL
	PUSH	AF
	PUSH	BC
	LD	BC,(VDP+1)
	INC	C

	PUSH	HL
	EXX
	POP	HL
	EXX
	LD	A,H
	AND	0C0H
	OR	E
	RLCA
	RLCA
	DI
	OUT	(C),A
	LD	A,8EH
	OUT	(C),A
	OUT	(C),L
	LD	A,H
	AND	3FH
	OUT	(C),A

	LD	A,7
	OUT	(0A0H),A
	LD	A,191
	OUT	(0A1H),A

	LD	BC,(VDP)
	LD	B,D
	POP	DE
	LD	A,E
	OR	D
	JR	Z,LOOP0
	INC	B
;//////////////////////////////////////
LOOP0:	LD	A,(HL)		;8	INC	HL	;7
LOOP1:	LD	A,R		;11 18
	IN	A,(C)		;14 32
	LD	L,A		;5  37
	LD	H,WKHIGH	;8  45
	LD	A,8		;8  53
	DI
	OUT	(0A0H),A	;12 65
	LD	A,(HL)		;8  73
	OUT	(0A1H),A	;12 85
	INC	H		;5  90
	LD	A,9		;8  98
	OUT	(0A0H),A	;12 110
	LD	A,(HL)		;8  118
	OUT	(0A1H),A	;12 130
	INC	H		;5  135
	LD	A,10		;8  143
	OUT	(0A0H),A	;12 155
	LD	A,(HL)		;8  163
	OUT	(0A1H),A	;12 175
	EI
TIME:	LD	A,01H		;8  183
LP5:	DEC	A		;5
	JP	NZ,LP5		;11 16*N
	DEC	DE		;7  190
	LD	A,D		;5  195
	OR	E		;5  200
	JP	NZ,LOOP0	;11 211
	DJNZ	LOOP1		;14
RETURN:	POP	AF
	CALL	4022H	;CHGCPU
	LD	L,07H
	CALL	PSGCHN

	XOR	A
	EI
	RET
;------------------------------------------
MRAM:	EXX			;5
	LD	A,(HL)		;8
	INC	HL		;7
	EXX			;5 25

VRAM:	LD	A,R		;11
	IN	A,(C)		;14 25
;------------------------------------------
	DEFS	31-2

ACH:	DEFB	00H,01H,03H,04H,05H,06H,06H,07H,07H,08H,08H,08H,08H,09H,09H,09H
	DEFB	09H,09H,0AH,0AH,0AH,0AH,0AH,0AH,0BH,0BH,0BH,0BH,0BH,0BH,0BH,0BH
	DEFB	0BH,0BH,0CH,0CH,0CH,0CH,0CH,0CH,0CH,0CH,0CH,0CH,0CH,0DH,0DH,0DH
	DEFB	0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH
	DEFB	0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH
	DEFB	0EH,0EH,0EH,0EH,0EH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
BCH:	DEFB	00H,00H,00H,01H,01H,00H,02H,01H,03H,00H,01H,03H,04H,01H,03H,04H
	DEFB	05H,06H,01H,03H,04H,05H,06H,06H,01H,03H,04H,05H,06H,06H,07H,07H
	DEFB	07H,08H,01H,03H,04H,05H,06H,06H,07H,07H,07H,08H,08H,01H,03H,04H
	DEFB	05H,06H,06H,07H,07H,07H,08H,08H,08H,09H,09H,09H,09H,09H,0AH,0AH
	DEFB	00H,01H,03H,04H,05H,06H,06H,07H,07H,08H,08H,08H,08H,09H,09H,09H
	DEFB	09H,09H,0AH,0AH,0AH,00H,01H,03H,04H,05H,06H,06H,07H,07H,08H,08H
	DEFB	08H,08H,09H,09H,09H,09H,09H,0AH,0AH,0AH,0AH,0AH,0AH,0BH,0BH,0BH
	DEFB	0BH,0BH,0BH,0BH,0BH,0BH,0BH,0CH,0CH,0CH,0CH,0CH,0CH,0CH,0CH,0CH
	DEFB	0CH,0CH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH
	DEFB	0DH,0DH,0DH,0DH,0DH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH
	DEFB	0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
	DEFB	0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH,0FH
CCH:	DEFB	00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,01H,00H,00H,00H
	DEFB	00H,00H,00H,00H,00H,00H,00H,01H,00H,00H,00H,00H,00H,01H,00H,02H
	DEFB	04H,01H,00H,00H,00H,00H,00H,01H,00H,02H,04H,01H,03H,00H,00H,00H
	DEFB	00H,00H,01H,00H,02H,04H,01H,03H,04H,00H,02H,04H,05H,05H,00H,02H
	DEFB	00H,00H,00H,01H,01H,00H,02H,01H,03H,00H,01H,03H,04H,01H,03H,04H
	DEFB	05H,06H,01H,03H,04H,00H,00H,00H,01H,01H,00H,02H,01H,03H,00H,01H
	DEFB	03H,04H,01H,03H,04H,05H,06H,01H,03H,04H,05H,06H,06H,01H,03H,04H
	DEFB	05H,06H,06H,07H,07H,07H,08H,01H,03H,04H,05H,06H,06H,07H,07H,07H
	DEFB	08H,08H,01H,03H,04H,05H,06H,06H,07H,07H,07H,08H,08H,08H,09H,09H
	DEFB	09H,09H,09H,0AH,0AH,00H,01H,03H,04H,05H,06H,06H,07H,07H,08H,08H
	DEFB	08H,08H,09H,09H,09H,09H,09H,0AH,0AH,0AH,00H,01H,03H,04H,05H,06H
	DEFB	06H,07H,07H,08H,08H,08H,08H,09H,09H,09H,09H,09H,0AH,0AH,0AH,0AH
	DEFB	0AH,0AH,0BH,0BH,0BH,0BH,0BH,0BH,0BH,0BH,0BH,0BH,0CH,0CH,0CH,0CH
	DEFB	0CH,0CH,0CH,0CH,0CH,0CH,0CH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH
	DEFB	0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0DH,0EH,0EH,0EH,0EH,0EH,0EH
	DEFB	0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0EH,0FH

	END
